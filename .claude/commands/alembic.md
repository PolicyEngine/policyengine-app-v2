You are creating or modifying Alembic database migrations in the `policyengine-api-v2-alpha` repo (`~/Documents/PolicyEngine/policyengine-api-v2-alpha`).

## Rules

### 1. MUST verify the database is running

Before any Alembic operation, confirm that the local Postgres database is reachable:

```bash
cd ~/Documents/PolicyEngine/policyengine-api-v2-alpha
pg_isready -h localhost -p 54322
```

If it is not running, tell the user and ask them to start it (e.g., `open -a Docker` and wait for Supabase containers). Do NOT proceed until the database is confirmed up.

### 2. MUST use Alembic autogenerate

Always generate migrations automatically from model changes:

```bash
cd ~/Documents/PolicyEngine/policyengine-api-v2-alpha
alembic revision --autogenerate -m "description_of_change"
```

Do NOT hand-write migration files. The autogenerate pipeline compares the SQLModel classes against the live database schema and produces the correct upgrade/downgrade operations.

### 3. MUST clean up autogenerate false positives

Every autogenerated migration will include spurious index drops that must be removed before committing. Delete any operations that reference:

- `ix_regions_code_model`
- `ix_user_policies_country_id`

Also verify the generated file includes `import sqlmodel.sql.sqltypes` if it uses `sqlmodel.sql.sqltypes.AutoString` — autogenerate sometimes forgets this import.

### 4. MUST verify the migration applies cleanly

After generating and cleaning up:

```bash
cd ~/Documents/PolicyEngine/policyengine-api-v2-alpha
alembic upgrade head
```

Confirm it completes without errors. If there is a problem, fix the migration file and re-run — do NOT hand-write a replacement.

### 5. Workflow summary

1. Make model changes in `src/policyengine_api/models/`
2. Verify database is running (`pg_isready -h localhost -p 54322`)
3. Run `alembic revision --autogenerate -m "description"`
4. Open the generated file, remove false-positive index drops, verify imports
5. Run `alembic upgrade head` to apply
6. Run `alembic check` to confirm no remaining drift (optional)

### 6. If the database is out of sync

If `alembic upgrade head` fails because the database has drifted (e.g., tables already exist or are missing), the safest fix is to reset the database schema and reapply all migrations:

```sql
-- Connect to the local database (port 54322)
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
```

Then run `alembic upgrade head` to rebuild from scratch. This is safe in local development — it only affects the local Supabase instance, not production.
