# Simulation & Report V2 Migration Progress

## Current: Phase 3, Task 7

## Branch Strategy

Each phase gets a feature branch per repo, based on the migration base branches.

| Repo | Path | Base branch | Feature branch pattern |
|---|---|---|---|
| policyengine.py | `~/Documents/PolicyEngine/policyengine.py` | `app-v2-migration` | `feat/sim-report-migration/phase-N` |
| policyengine-api-v2-alpha | `~/Documents/PolicyEngine/policyengine-api-v2-alpha` | `app-v2-migration` | `feat/sim-report-migration/phase-N` |
| policyengine-app-v2 | `~/Documents/PolicyEngine/policyengine-app-v2` | `move-to-api-v2` | `feat/sim-report-migration/phase-N` |

**Rules:**
- Feature branches are created at the start of each phase (with user approval)
- All task commits within a phase go to that phase's feature branch
- Merging feature branches into base branches requires explicit user instruction
- Pushing to remote requires explicit user instruction

## Active Branches

_(Updated as branches are created)_

| Repo | Current branch | Created | Status |
|---|---|---|---|
| policyengine.py | `feat/sim-report-migration/phase-3` | 2026-02-20 | Active |
| policyengine-api-v2-alpha | `feat/sim-report-migration/phase-3` | 2026-02-20 | Active |
| policyengine-app-v2 | — | — | Not started |

---

## Phase 1: Foundation (API v2 alpha)

- [x] 1. Fix Alembic migration branch conflict (2026-02-18)
  - [x] API: Create merge migration reconciling `0002_user_policies` and `f419b5f4acba`
  - [x] API: Verify `alembic upgrade head` succeeds cleanly
- [x] 2. Add `filter_field`/`filter_value` to `simulations` table (2026-02-18)
  - [x] API: Create Alembic migration adding both columns (nullable strings)
  - [x] API: Verify Simulation model matches DB schema
- [x] 3. Remove `parent_report_id` from Report model (2026-02-18, kept `markdown` per user request)
  - [x] API: Create Alembic migration dropping `parent_report_id` column and FK
  - [x] API: Remove field from `ReportBase` in `models/report.py`
  - [x] API: No code referenced `parent_report_id` — no other changes needed
  - [x] API: DB schema verified (fresh `alembic upgrade head` + autogenerate pipeline set up)
- [x] 4. Create `user_simulation_associations` table + CRUD endpoints (2026-02-18)
  - [x] API: Create `UserSimulationAssociation` model (following `UserPolicy` pattern)
  - [x] API: Create Alembic migration for the table (autogenerated)
  - [x] API: Create `api/user_simulation_associations.py` with CRUD endpoints
  - [x] API: Register router in `api/__init__.py`
  - [x] API: 15 tests pass
- [x] 5. Create `user_report_associations` table + CRUD endpoints (2026-02-19)
  - [x] API: Create `UserReportAssociation` model (with `last_run_at` field)
  - [x] API: Create Alembic migration for the table (autogenerated)
  - [x] API: Create `api/user_report_associations.py` with CRUD endpoints
  - [x] API: Register router in `api/__init__.py`
  - [x] API: 16 tests pass
- [x] 6. Create standalone simulation endpoints (`/simulations/household`, `/simulations/economy`) (2026-02-19)
  - [x] API: Add POST/GET routes to `api/simulations.py` (non-blocking, returns pending)
  - [x] API: `/simulations/household` — create Simulation record, return pending status
  - [x] API: `/simulations/economy` — create Simulation record, return pending status
  - [x] API: Validate region against `regions` table for economy sims
  - [x] API: 19 tests pass
- [x] 7. Create missing Modal functions (`household_impact_uk`, `household_impact_us`) (2026-02-19)
  - [x] API: Implement `household_impact_uk` in `modal_app.py`
  - [x] API: Implement `household_impact_us` in `modal_app.py`
  - [x] API: Verify `household_analysis.py` can invoke them (function names match caller)
- [x] 8. Create `_run_local_economy_comparison_us` local fallback (2026-02-19)
  - [x] API: Implement in `analysis.py` (following `_run_local_economy_comparison_uk` pattern)
  - [x] API: Update `_trigger_economy_comparison()` to use it instead of falling back to Modal
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)

---

## Phase 2: V1 Output Parity (API v2 alpha + .py)

- [x] 1. Wire up poverty computation (overall) in economy comparison (2026-02-19)
  - [x] .py: Add `poverty_type` field to `Poverty` class, harmonize with API types
  - [x] .py: Update `calculate_uk_poverty_rates()` and `calculate_us_poverty_rates()` to populate `poverty_type`
  - [x] API (local): Call poverty functions in `_run_local_economy_comparison_uk`, store in `poverty` table
  - [x] API (local): Call poverty functions in `_run_local_economy_comparison_us`, store in `poverty` table
  - [x] API (Modal): Extend `economy_comparison_uk` to compute and store poverty
  - [x] API (Modal): Extend `economy_comparison_us` to compute and store poverty
  - [x] API: Add `poverty` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [x] 2. Wire up inequality computation (2026-02-19)
  - [x] .py: Verified `calculate_us_inequality()` and `calculate_uk_inequality()` exist with matching fields
  - [x] API (local): Call inequality functions in both UK and US local comparison, store in `inequality` table
  - [x] API (Modal): Extend both economy comparison functions to compute inequality
  - [x] API: Add `inequality` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [x] 3. Add poverty by age group (2026-02-19)
  - [x] .py: Create convenience functions (`calculate_us_poverty_by_age()`, `calculate_uk_poverty_by_age()`)
  - [x] .py: pytest passes (219 passed, 57 pre-existing failures)
  - [x] API: Call age-group poverty functions, store as `poverty` records with `filter_variable`
  - [x] API (Modal): Same in Modal functions
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [x] 4. Add poverty by gender (2026-02-19)
  - [x] .py: Add `is_male` to both UK and US `entity_variables`
  - [x] .py: Create gender poverty convenience functions
  - [x] .py: pytest passes (219 passed, 57 pre-existing failures)
  - [x] API: Wire gender poverty into economy comparison
  - [x] API (Modal): Same in Modal functions
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [x] 5. Add poverty by race (2026-02-20)
  - [x] .py: Add `race` to US `entity_variables`
  - [x] .py: Create `calculate_us_poverty_by_race()` convenience function
  - [x] .py: pytest passes (219 passed, 57 pre-existing failures)
  - [x] API: Wire racial poverty into US economy comparison
  - [x] API (Modal): Same in US Modal function
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [x] 6. Add budget summary (2026-02-20)
  - [x] .py: Add `household_state_income_tax` to US tax_unit entity_variables
  - [x] API: Create `budget_summary` table (BudgetSummary model + Alembic migration)
  - [x] API: Compute budget aggregates in UK/US local comparison (Aggregate for monetary vars, raw numpy for household count)
  - [x] API (Modal): Same in UK/US Modal functions
  - [x] API: Add `budget_summary` to EconomicImpactResponse and `_build_response()`
  - [x] API: pytest passes (218 passed, 47 pre-existing failures)
- [x] 7. Add intra-decile breakdown (5-category threshold classification) (2026-02-20)
  - [x] .py: Add `household_income_decile` and `household_count_people` to UK and US entity_variables
  - [x] API: Create `intra_decile_impacts` table (IntraDecileImpact model + Alembic migration)
  - [x] API: Create `intra_decile.py` helper with two formula functions (V1 original + corrected) and strategy selector
  - [x] API: Wire intra-decile computation into UK/US local and Modal functions
  - [x] API: Add `intra_decile` to EconomicImpactResponse and `_build_response()`
  - [x] API: pytest passes (29/29 analysis tests)
- [x] 8. Add detailed budget / per-program breakdown (2026-02-20)
  - [x] API: Add `detailed_budget` dict to `EconomicImpactResponse`, derived from ProgramStatistics
  - [x] API: Expand UK local program list from 4 to 10 (matching Modal)
  - [x] API: pytest passes (29/29 analysis tests)
- [x] 9. Create `/analysis/economy` and `/analysis/household` endpoints with full output structures (2026-02-20)
  - [x] API: Existing `/analysis/economic-impact` and `/analysis/household-impact` names kept (user decision)
  - [x] API: Full response structures already complete from Tasks 1-8 (remaining fields are Phase 3)
  - [x] API: pytest passes (29/29 analysis tests)
- [x] 10. Write tests for Phase 2 changes (`/write-tests`) (2026-02-20)
  - [x] .py: Tests for convenience functions (poverty by age/gender/race) — 16 tests
  - [x] API: Tests for intra-decile computation (formula variants, edge cases) — 20 tests
  - [x] API: Tests for _build_response (poverty, inequality, budget_summary, intra_decile, program_statistics, detailed_budget) — 32 tests
  - [x] All 68 new tests pass

---

## Phase 3: Expensive Computations (.py + API v2 alpha)

- [x] 1. Congressional district impact (US) (2026-02-20)
  - [x] .py: Add `congressional_district_geoid` to US household entity_variables
  - [x] .py: Create `CongressionalDistrictImpact` output class + `compute_us_congressional_district_impacts()`
  - [x] .py: pytest passes (92 tests)
  - [x] API: Create `congressional_district_impacts` table (model + Alembic migration)
  - [x] API: Wire computation into `_run_local_economy_comparison_us` and Modal `economy_comparison_us`
  - [x] API: Add `congressional_district_impact` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (83 analysis tests)
- [x] 2. UK constituency impact (2026-02-20)
  - [x] .py: Create `ConstituencyImpact` output class + `compute_uk_constituency_impacts()` (weight matrix reweighting)
  - [x] .py: pytest passes (92 tests)
  - [x] API: Create `constituency_impacts` table (model + Alembic migration)
  - [x] API: Wire computation into `_run_local_economy_comparison_uk` and Modal `economy_comparison_uk`
  - [x] API: Add `constituency_impact` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (29 analysis tests)
- [x] 3. UK local authority impact (2026-02-20)
  - [x] .py: Create `LocalAuthorityImpact` output class + `compute_uk_local_authority_impacts()` (weight matrix reweighting)
  - [x] .py: pytest passes (92 tests)
  - [x] API: Create `local_authority_impacts` table (model + Alembic migration)
  - [x] API: Wire computation into `_run_local_economy_comparison_uk` and Modal `economy_comparison_uk`
  - [x] API: Add `local_authority_impact` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (29 analysis tests)
- [ ] 4. Labor supply response — **DEFERRED** (complex, needs design decisions; detailed plan written 2026-02-20)
  - [ ] .py: Build LSR computation (income/substitution effects, hours, revenue change)
  - [ ] .py: pytest passes
  - [ ] API: Wire into economy comparison (both local and Modal)
  - [ ] API: Add `labor_supply_response` to economy response
  - [ ] API: pytest passes
- [ ] 5. Cliff impact — **DEFERRED** (expensive computation, needs design decisions; detailed plan written 2026-02-20)
  - [ ] .py: Build cliff rate/gap analysis
  - [ ] .py: pytest passes
  - [ ] API: Wire into economy comparison
  - [ ] API: Add `cliff_impact` to economy response
  - [ ] API: pytest passes
- [x] 6. Wealth decile impact (UK) + refactor intra-decile to policyengine.py (2026-02-20)
  - [x] .py: Add `decile_variable` param to `DecileImpact` for pre-computed groupings
  - [x] .py: Create `IntraDecileImpact` output class + `compute_intra_decile_impacts()` (qcut by default)
  - [x] .py: Add `household_wealth_decile` to UK entity_variables
  - [x] .py: pytest passes (239 tests)
  - [x] API: Migrate all intra-decile computation (UK+US, local+Modal) from `api/intra_decile.py` to policyengine.py
  - [x] API: Add `decile_type` column to `intra_decile_impacts` table (Alembic migration)
  - [x] API: Wire wealth decile + intra-wealth-decile into UK economy comparison (local + Modal)
  - [x] API: Add `wealth_decile` and `intra_wealth_decile` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (29 passed, 2 skipped)
- [ ] 7. Write tests for Phase 3 changes (`/write-tests`)
  - [ ] .py: Tests for new computation functions
  - [ ] API: Tests for new response fields and computation wiring
  - [ ] All new tests pass

---

## Phase 4: Custom Modules (API v2 alpha)

- [ ] 1. Define module registry with computation functions
  - [ ] API: Create module registry mapping names to computation functions
  - [ ] API: Each module has a name, description, and compute function
- [ ] 2. Create `/analysis/options` endpoint
  - [ ] API: GET endpoint returning available modules with descriptions
  - [ ] API: pytest passes
- [ ] 3. Create `/analysis/economy-custom` endpoint
  - [ ] API: POST endpoint accepting region + policy + module name array
  - [ ] API: Validates module names against registry
  - [ ] API: Only computes requested modules
  - [ ] API: pytest passes
- [ ] 4. Refactor Modal economy comparison functions into composable modules
  - [ ] API: Extract module computation into callable units
  - [ ] API: `/analysis/economy` calls all modules; `/analysis/economy-custom` calls selected ones
  - [ ] API: pytest passes
- [ ] 5. Write tests for Phase 4 changes (`/write-tests`)
  - [ ] API: Tests for module registry, `/analysis/options`, `/analysis/economy-custom`
  - [ ] All new tests pass

---

## Phase 4a: Lazy Metadata Loading (API v2 alpha + app v2)

_Full spec: `.claude-plan/LAZY_METADATA_SPEC.md`_

- [ ] 1. Add batch parameter endpoint (`POST /parameters/batch`)
  - [ ] API: New endpoint accepting `{ names: string[], tax_benefit_model_name: string }`
  - [ ] API: Return `ParameterRead[]` matching the given names
  - [ ] API: pytest passes
- [ ] 2. Add parameter children endpoint (`GET /parameters/children`)
  - [ ] API: Accept `parent_path` and `tax_benefit_model_name` query params
  - [ ] API: Return structured children (nodes with child_count + leaf parameters)
  - [ ] API: pytest passes
- [ ] 3. Add batch variable endpoint (`POST /variables/batch`)
  - [ ] API: New endpoint accepting `{ names: string[], tax_benefit_model_name: string }`
  - [ ] API: Return `VariableRead[]` matching the given names
  - [ ] API: pytest passes
- [ ] 4. Add model-by-country endpoint (`GET /tax-benefit-models/by-country/{country_id}`)
  - [ ] API: Return model + latest version in one call
  - [ ] API: pytest passes
- [ ] 5. Write tests for Phase 4a API changes (`/write-tests`)
  - [ ] API: Tests for batch parameter, children, batch variable, model-by-country
  - [ ] All new tests pass
- [ ] 6. Create app v2 API modules for lazy loading
  - [ ] App: `api/v2/parameterTree.ts` with `fetchParameterChildren()`, `fetchParametersBatch()`
  - [ ] App: `api/v2/variablesBatch.ts` with `fetchVariablesBatch()`
  - [ ] App: Update `api/v2/taxBenefitModels.ts` with `fetchModelByCountry()`
  - [ ] App: typecheck + lint + prettier pass
- [ ] 7. Create TanStack Query hooks for lazy loading
  - [ ] App: `useParameterChildren(parentPath, countryId)`
  - [ ] App: `usePolicyParameters(policy)`
  - [ ] App: `useModelVersion(countryId)`
  - [ ] App: typecheck + lint + prettier pass
- [ ] 8. Add localStorage caching layer
  - [ ] App: `libs/metadataCache.ts` — read/write/invalidate, version comparison
  - [ ] App: Hydrate TanStack Query from localStorage on load
  - [ ] App: Write-through: persist new API responses to localStorage
  - [ ] App: typecheck + lint + prettier pass
- [ ] 9. Replace bulk parameter fetch with lazy tree loading
  - [ ] App: Remove `fetchParameters()` from `fetchMetadataThunk`
  - [ ] App: Update `useLazyParameterTree` to use API-backed `useParameterChildren`
  - [ ] App: Loading states per tree level
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 10. Replace bulk variable fetch with cached/background fetch
  - [ ] App: Move variable fetch out of critical path (background or cache-first)
  - [ ] App: Household builder search works with cached variables
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 11. Write tests for Phase 4a app changes (`/write-tests`)
  - [ ] App: Tests for new hooks, API modules, cache layer
  - [ ] All new tests pass

---

## Phase 5: App Migration (app v2)

- [ ] 1. Create v2 API modules
  - [ ] App: `api/v2/simulations.ts` (simulation CRUD + run endpoints)
  - [ ] App: `api/v2/reports.ts` (report CRUD + status polling)
  - [ ] App: `api/v2/economyAnalysis.ts` (economy analysis job creation + polling)
  - [ ] App: `api/v2/householdAnalysis.ts` (household analysis job creation + polling)
  - [ ] App: `api/v2/analysisOptions.ts` (fetch available economy modules)
  - [ ] App: `api/v2/userSimulationAssociations.ts` (user-simulation CRUD)
  - [ ] App: `api/v2/userReportAssociations.ts` (user-report CRUD)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 2. Create v2 adapters
  - [ ] App: Add v2 methods to `SimulationAdapter` (UUID IDs, v2 field names)
  - [ ] App: Add v2 methods to `ReportAdapter` (UUID IDs, v2 field names)
  - [ ] App: Add v2 methods to `UserSimulationAdapter`
  - [ ] App: Add v2 methods to `UserReportAdapter` (with `lastRunAt`)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 3. Rewrite `SocietyWideCalcStrategy` for v2
  - [ ] App: Switch from v1 polling to v2 job-based pattern
  - [ ] App: Handle v2 response shape (typed output records vs. JSON blob)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 4. Update `HouseholdCalcStrategy` for v2 analysis endpoint
  - [ ] App: Point at `/analysis/household` instead of legacy `/household/calculate`
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 5. Update `ResultPersister` for v2
  - [ ] App: Switch from v1 simulation/report update calls to v2 equivalents
  - [ ] App: Or remove entirely if v2 handles persistence server-side
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 6. Wire up association stores to v2 API
  - [ ] App: Implement `ApiSimulationStore` methods delegating to v2 module
  - [ ] App: Implement `ApiReportStore` methods delegating to v2 module
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 7. Update hooks
  - [ ] App: `useUserSimulations` → v2 API
  - [ ] App: `useUserReports` → v2 API
  - [ ] App: `useCreateSimulation` → v2 simulation creation
  - [ ] App: `useCreateReport` → v2 report creation
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 8. Deprecate v1 API files
  - [ ] App: Remove or mark deprecated: `api/simulation.ts`, `api/report.ts`, `api/societyWideCalculation.ts`, `api/reportCalculations.ts`
  - [ ] App: Remove v1-specific adapter methods
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 9. Write tests for Phase 5 changes (`/write-tests`)
  - [ ] App: Tests for v2 API modules, adapters, strategies, hooks
  - [ ] All new tests pass

---

## Decisions Log

_(Decisions and blockers will be recorded here as they arise)_
