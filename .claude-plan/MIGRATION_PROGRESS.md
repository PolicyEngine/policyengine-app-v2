# Simulation & Report V2 Migration Progress

## Current: Phase 2, Task 2

## Branch Strategy

Each phase gets a feature branch per repo, based on the migration base branches.

| Repo | Path | Base branch | Feature branch pattern |
|---|---|---|---|
| policyengine.py | `~/Documents/PolicyEngine/policyengine.py` | `app-v2-migration` | `feat/sim-report-migration/phase-N` |
| policyengine-api-v2-alpha | `~/Documents/PolicyEngine/policyengine-api-v2-alpha` | `app-v2-migration` | `feat/sim-report-migration/phase-N` |
| policyengine-app-v2 | `~/Documents/PolicyEngine/policyengine-app-v2` | `move-to-api-v2` | `feat/sim-report-migration/phase-N` |

**Rules:**
- Feature branches are created at the start of each phase (with user approval)
- All task commits within a phase go to that phase's feature branch
- Merging feature branches into base branches requires explicit user instruction
- Pushing to remote requires explicit user instruction

## Active Branches

_(Updated as branches are created)_

| Repo | Current branch | Created | Status |
|---|---|---|---|
| policyengine.py | `feat/sim-report-migration/phase-2` | 2026-02-19 | Active |
| policyengine-api-v2-alpha | `feat/sim-report-migration/phase-2` | 2026-02-19 | Active |
| policyengine-app-v2 | — | — | Not started |

---

## Phase 1: Foundation (API v2 alpha)

- [x] 1. Fix Alembic migration branch conflict (2026-02-18)
  - [x] API: Create merge migration reconciling `0002_user_policies` and `f419b5f4acba`
  - [x] API: Verify `alembic upgrade head` succeeds cleanly
- [x] 2. Add `filter_field`/`filter_value` to `simulations` table (2026-02-18)
  - [x] API: Create Alembic migration adding both columns (nullable strings)
  - [x] API: Verify Simulation model matches DB schema
- [x] 3. Remove `parent_report_id` from Report model (2026-02-18, kept `markdown` per user request)
  - [x] API: Create Alembic migration dropping `parent_report_id` column and FK
  - [x] API: Remove field from `ReportBase` in `models/report.py`
  - [x] API: No code referenced `parent_report_id` — no other changes needed
  - [x] API: DB schema verified (fresh `alembic upgrade head` + autogenerate pipeline set up)
- [x] 4. Create `user_simulation_associations` table + CRUD endpoints (2026-02-18)
  - [x] API: Create `UserSimulationAssociation` model (following `UserPolicy` pattern)
  - [x] API: Create Alembic migration for the table (autogenerated)
  - [x] API: Create `api/user_simulation_associations.py` with CRUD endpoints
  - [x] API: Register router in `api/__init__.py`
  - [x] API: 15 tests pass
- [x] 5. Create `user_report_associations` table + CRUD endpoints (2026-02-19)
  - [x] API: Create `UserReportAssociation` model (with `last_run_at` field)
  - [x] API: Create Alembic migration for the table (autogenerated)
  - [x] API: Create `api/user_report_associations.py` with CRUD endpoints
  - [x] API: Register router in `api/__init__.py`
  - [x] API: 16 tests pass
- [x] 6. Create standalone simulation endpoints (`/simulations/household`, `/simulations/economy`) (2026-02-19)
  - [x] API: Add POST/GET routes to `api/simulations.py` (non-blocking, returns pending)
  - [x] API: `/simulations/household` — create Simulation record, return pending status
  - [x] API: `/simulations/economy` — create Simulation record, return pending status
  - [x] API: Validate region against `regions` table for economy sims
  - [x] API: 19 tests pass
- [x] 7. Create missing Modal functions (`household_impact_uk`, `household_impact_us`) (2026-02-19)
  - [x] API: Implement `household_impact_uk` in `modal_app.py`
  - [x] API: Implement `household_impact_us` in `modal_app.py`
  - [x] API: Verify `household_analysis.py` can invoke them (function names match caller)
- [x] 8. Create `_run_local_economy_comparison_us` local fallback (2026-02-19)
  - [x] API: Implement in `analysis.py` (following `_run_local_economy_comparison_uk` pattern)
  - [x] API: Update `_trigger_economy_comparison()` to use it instead of falling back to Modal
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)

---

## Phase 2: V1 Output Parity (API v2 alpha + .py)

- [x] 1. Wire up poverty computation (overall) in economy comparison (2026-02-19)
  - [x] .py: Add `poverty_type` field to `Poverty` class, harmonize with API types
  - [x] .py: Update `calculate_uk_poverty_rates()` and `calculate_us_poverty_rates()` to populate `poverty_type`
  - [x] API (local): Call poverty functions in `_run_local_economy_comparison_uk`, store in `poverty` table
  - [x] API (local): Call poverty functions in `_run_local_economy_comparison_us`, store in `poverty` table
  - [x] API (Modal): Extend `economy_comparison_uk` to compute and store poverty
  - [x] API (Modal): Extend `economy_comparison_us` to compute and store poverty
  - [x] API: Add `poverty` to `EconomicImpactResponse` and `_build_response()`
  - [x] API: pytest passes (219 passed, 57 pre-existing failures)
- [ ] 2. Wire up inequality computation
  - [ ] .py: Verify `calculate_us_inequality()` and `calculate_uk_inequality()` work
  - [ ] API (local): Call inequality functions, store in `inequality` table
  - [ ] API (Modal): Extend both economy comparison functions to compute inequality
  - [ ] API: Add `inequality` to `EconomicImpactResponse` and `_build_response()`
  - [ ] API: pytest passes
- [ ] 3. Add poverty by age group
  - [ ] .py: Create convenience functions (`calculate_us_poverty_by_age()`, `calculate_uk_poverty_by_age()`)
  - [ ] .py: pytest passes
  - [ ] API: Call age-group poverty functions, store as `poverty` records with `filter_variable`
  - [ ] API (Modal): Same in Modal functions
  - [ ] API: pytest passes
- [ ] 4. Add poverty by gender
  - [ ] .py: Add gender variable to US `entity_variables` (UK already has it)
  - [ ] .py: Create gender poverty convenience functions
  - [ ] .py: pytest passes
  - [ ] API: Wire gender poverty into economy comparison
  - [ ] API (Modal): Same in Modal functions
  - [ ] API: pytest passes
- [ ] 5. Add poverty by race
  - [ ] .py: Add race variables to US `entity_variables`
  - [ ] .py: Create racial poverty convenience functions
  - [ ] .py: pytest passes
  - [ ] API: Wire racial poverty into economy comparison
  - [ ] API (Modal): Same in Modal functions
  - [ ] API: pytest passes
- [ ] 6. Add budget summary
  - [ ] API: Derive net budgetary impact from ProgramStatistics (sum tax changes → revenue, benefit changes → spending)
  - [ ] API: Add `budget` section to response (matching V1 shape)
  - [ ] API: pytest passes
- [ ] 7. Add intra-decile breakdown (5-category threshold classification)
  - [ ] .py: Extend DecileImpact or create new output class for 5-category classification
  - [ ] .py: pytest passes
  - [ ] API: Create new output table or extend response with intra-decile data
  - [ ] API (Modal): Compute intra-decile in both economy comparison functions
  - [ ] API: pytest passes
- [ ] 8. Add detailed budget / per-program breakdown
  - [ ] API: Format ProgramStatistics into V1's `detailed_budget` structure in response
  - [ ] API: pytest passes
- [ ] 9. Create `/analysis/economy` and `/analysis/household` endpoints with full output structures
  - [ ] API: Create `/analysis/economy` (or rename existing `/analysis/economic-impact`)
  - [ ] API: Create `/analysis/household` (or rename existing `/analysis/household-impact`)
  - [ ] API: Full response structures matching V1 parity
  - [ ] API: pytest passes

---

## Phase 3: Expensive Computations (.py + API v2 alpha)

- [ ] 1. Congressional district impact (US)
  - [ ] .py: Create per-district analysis function or batched aggregate approach
  - [ ] .py: pytest passes
  - [ ] API: Create dedicated Modal function or batching strategy for 435 districts
  - [ ] API: Add `congressional_district_impact` to economy response
  - [ ] API: pytest passes
- [ ] 2. UK constituency impact
  - [ ] .py: Create per-constituency analysis function
  - [ ] .py: pytest passes
  - [ ] API: Wire into UK economy comparison
  - [ ] API: pytest passes
- [ ] 3. UK local authority impact
  - [ ] .py: Create per-local-authority analysis function
  - [ ] .py: pytest passes
  - [ ] API: Wire into UK economy comparison
  - [ ] API: pytest passes
- [ ] 4. Labor supply response
  - [ ] .py: Build LSR computation (income/substitution effects, hours, revenue change)
  - [ ] .py: pytest passes
  - [ ] API: Wire into economy comparison (both local and Modal)
  - [ ] API: Add `labor_supply_response` to economy response
  - [ ] API: pytest passes
- [ ] 5. Cliff impact
  - [ ] .py: Build cliff rate/gap analysis
  - [ ] .py: pytest passes
  - [ ] API: Wire into economy comparison
  - [ ] API: Add `cliff_impact` to economy response
  - [ ] API: pytest passes
- [ ] 6. Wealth decile impact (UK)
  - [ ] .py: Create wealth-based decile output class
  - [ ] .py: pytest passes
  - [ ] API: Wire into UK economy comparison
  - [ ] API: Add `wealth_decile` and `intra_wealth_decile` to economy response
  - [ ] API: pytest passes

---

## Phase 4: Custom Modules (API v2 alpha)

- [ ] 1. Define module registry with computation functions
  - [ ] API: Create module registry mapping names to computation functions
  - [ ] API: Each module has a name, description, and compute function
- [ ] 2. Create `/analysis/options` endpoint
  - [ ] API: GET endpoint returning available modules with descriptions
  - [ ] API: pytest passes
- [ ] 3. Create `/analysis/economy-custom` endpoint
  - [ ] API: POST endpoint accepting region + policy + module name array
  - [ ] API: Validates module names against registry
  - [ ] API: Only computes requested modules
  - [ ] API: pytest passes
- [ ] 4. Refactor Modal economy comparison functions into composable modules
  - [ ] API: Extract module computation into callable units
  - [ ] API: `/analysis/economy` calls all modules; `/analysis/economy-custom` calls selected ones
  - [ ] API: pytest passes

---

## Phase 5: App Migration (app v2)

- [ ] 1. Create v2 API modules
  - [ ] App: `api/v2/simulations.ts` (simulation CRUD + run endpoints)
  - [ ] App: `api/v2/reports.ts` (report CRUD + status polling)
  - [ ] App: `api/v2/economyAnalysis.ts` (economy analysis job creation + polling)
  - [ ] App: `api/v2/householdAnalysis.ts` (household analysis job creation + polling)
  - [ ] App: `api/v2/analysisOptions.ts` (fetch available economy modules)
  - [ ] App: `api/v2/userSimulationAssociations.ts` (user-simulation CRUD)
  - [ ] App: `api/v2/userReportAssociations.ts` (user-report CRUD)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 2. Create v2 adapters
  - [ ] App: Add v2 methods to `SimulationAdapter` (UUID IDs, v2 field names)
  - [ ] App: Add v2 methods to `ReportAdapter` (UUID IDs, v2 field names)
  - [ ] App: Add v2 methods to `UserSimulationAdapter`
  - [ ] App: Add v2 methods to `UserReportAdapter` (with `lastRunAt`)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 3. Rewrite `SocietyWideCalcStrategy` for v2
  - [ ] App: Switch from v1 polling to v2 job-based pattern
  - [ ] App: Handle v2 response shape (typed output records vs. JSON blob)
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 4. Update `HouseholdCalcStrategy` for v2 analysis endpoint
  - [ ] App: Point at `/analysis/household` instead of legacy `/household/calculate`
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 5. Update `ResultPersister` for v2
  - [ ] App: Switch from v1 simulation/report update calls to v2 equivalents
  - [ ] App: Or remove entirely if v2 handles persistence server-side
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 6. Wire up association stores to v2 API
  - [ ] App: Implement `ApiSimulationStore` methods delegating to v2 module
  - [ ] App: Implement `ApiReportStore` methods delegating to v2 module
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 7. Update hooks
  - [ ] App: `useUserSimulations` → v2 API
  - [ ] App: `useUserReports` → v2 API
  - [ ] App: `useCreateSimulation` → v2 simulation creation
  - [ ] App: `useCreateReport` → v2 report creation
  - [ ] App: typecheck + lint + prettier + tests pass
- [ ] 8. Deprecate v1 API files
  - [ ] App: Remove or mark deprecated: `api/simulation.ts`, `api/report.ts`, `api/societyWideCalculation.ts`, `api/reportCalculations.ts`
  - [ ] App: Remove v1-specific adapter methods
  - [ ] App: typecheck + lint + prettier + tests pass

---

## Decisions Log

_(Decisions and blockers will be recorded here as they arise)_
